name: ios-ci

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode_15*.app | head -n 1 || echo "/Applications/Xcode.app")
          sudo xcode-select -s "$XCODE_PATH"
          xcodebuild -version

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: |
          cd zariz/ios
          xcodegen generate

      - name: Build and test (simulator)
        run: |
          cd zariz/ios
          xcodebuild -scheme Zariz -destination 'platform=iOS Simulator,name=iPhone 15' -sdk iphonesimulator -configuration Debug clean test | xcpretty

      - name: SwiftLint (optional)
        if: always()
        run: |
          brew install swiftlint || true
          if [ -f zariz/ios/.swiftlint.yml ]; then swiftlint --config zariz/ios/.swiftlint.yml; else swiftlint || true; fi

      - name: Build for archive (optional)
        if: github.event_name == 'workflow_dispatch'
        run: |
          cd zariz/ios
          xcodebuild -scheme Zariz -configuration Release -sdk iphoneos -destination 'generic/platform=iOS' clean build | xcpretty

